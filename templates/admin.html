<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard ‚Äî API Wired</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f6f7fb;
    --panel: #ffffff;
    --line: #e7e9f0;
    --muted: #6b7280;
    --text: #0f172a;
    --brand: #263785;
    --brand-2: #1e2d70;
    --radius: 14px;
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
  }

  * {
    box-sizing: border-box;
  }

  html, body {
    height: 100%;
    margin: 0;
    font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  h1, h2, h3 {
    margin: 0 0 10px;
  }

  a {
    color: inherit;
    text-decoration: none;
  }

  input, select, textarea {
    width: 100%;
    border: 1px solid var(--line);
    border-radius: 10px;
    background: #fff;
    color: inherit;
    padding: 10px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--brand);
    box-shadow: 0 0 0 3px rgba(38, 55, 133, 0.1);
    outline: none;
  }

  textarea {
    min-height: 180px;
    resize: vertical;
  }

  .app {
    display: grid;
    grid-template-columns: 260px 1fr;
    min-height: 100vh;
    transition: all 0.3s ease;
  }

  @media (max-width: 1024px) {
    .app {
      grid-template-columns: 72px 1fr;
    }
    .hide-sm {
      display: none;
    }
  }

  /* Sidebar */
  .sidebar {
    background: linear-gradient(180deg, var(--brand), var(--brand-2));
    color: #eaf0ff;
    position: sticky;
    top: 0;
    height: 100vh;
    width: 260px;
    transition: width 0.3s ease;
    z-index: 1000;
  }

  .sidebar.collapsed {
    width: 72px;
  }

  .sidebar.collapsed .side-title,
  .sidebar.collapsed .menu h4,
  .sidebar.collapsed details.menu-group > div {
    display: none;
  }

  .sidebar.collapsed summary {
    padding-left: 14px;
  }

  .side-head {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  .side-logo {
    width: 34px;
    height: 34px;
    border-radius: 8px;
    background: #fff;
  }

  .side-title {
    font-weight: 800;
    letter-spacing: 0.3px;
  }

  .menu {
    padding: 8px 10px;
  }

  .menu h4 {
    margin: 14px 10px 6px;
    font-size: 12px;
    opacity: 0.85;
    font-weight: 700;
  }

  details.menu-group {
    margin: 6px 0;
    border-radius: 10px;
  }

  details.menu-group summary {
    list-style: none;
    cursor: pointer;
    padding: 10px 12px;
    border-radius: 10px;
    transition: background 0.2s ease;
  }

  details.menu-group[open] summary {
    background: rgba(255, 255, 255, 0.08);
  }

  details.menu-group > div {
    padding: 6px 0 8px 8px;
  }

  .sub {
    display: block;
    padding: 8px 12px;
    border-radius: 8px;
    color: #e8ecff;
    opacity: 0.95;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .sub:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .switch {
    position: absolute;
    left: -9999px;
    top: -9999px;
  }

  .panel {
    display: none;
  }

  #r-cat-create:checked ~ .content #panel-cat-create { display: block; }
  #r-cat-list:checked ~ .content #panel-cat-list { display: block; }
  #r-blog-create:checked ~ .content #panel-blog-create { display: block; }
  #r-blog-list:checked ~ .content #panel-blog-list { display: block; }

  .main {
    display: grid;
    grid-template-rows: 64px 1fr;
  }

  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fff;
    border-bottom: 1px solid var(--line);
    padding: 0 16px;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  .toggle-sidebar-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 40px;
    width: 40px;
    border: none;
    background: none;
    font-size: 24px;
    color: var(--brand);
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .toggle-sidebar-btn:hover {
    color: var(--brand-2);
  }

  .search {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #fff;
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 8px 12px;
    min-width: 260px;
  }

  .search input {
    border: 0;
    outline: 0;
    padding: 0;
    background: transparent;
  }

  .content {
    padding: 18px;
  }

  .card {
    background: #fff;
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  .pad {
    padding: 16px;
  }

  .row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }

  @media (max-width: 900px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  .btn {
    display: inline-block;
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 10px 12px;
    background: #fff;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s, transform 0.1s ease;
  }

  .btn:hover {
    background: #f0f2f5;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .btn:active {
    transform: scale(0.97);
  }

  .btn.primary {
    background: #111827;
    color: #fff;
    border-color: #111827;
  }

  .btn.ghost {
    background: #fff;
  }

  .btn.danger {
    color: #b91c1c;
    border-color: #ef4444;
  }

  .btn.info {
    color: #2563eb;
    border-color: #60a5fa;
  }

  .table {
    width: 100%;
    border-collapse: collapse;
  }

  .table th,
  .table td {
    padding: 10px;
    border-bottom: 1px solid var(--line);
    text-align: left;
    vertical-align: top;
  }

  .pill {
    display: inline-block;
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: 3px 8px;
    font-size: 12px;
    color: var(--muted);
  }

  /* Hide profile uploader */
  .profile-top {
    display: none !important;
  }

  /* Toast */
  .toast {
    position: fixed;
    right: 16px;
    bottom: 16px;
    background: #0f172a;
    color: #fff;
    padding: 10px 12px;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    opacity: 0;
    transform: translateY(8px);
    transition: all 0.3s ease;
    z-index: 9999;
    max-width: 300px;
    white-space: pre-wrap;
  }

  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }
</style>



</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="side-head">
      <div class="side-logo"></div>
      <div class="side-title hide-sm">ADMIN</div>
    </div>

    <nav class="menu">
      <h4>Category Management</h4>
      <details class="menu-group" open>
        <summary>Categories</summary>
        <div>
          <label class="sub" for="r-cat-create">Create</label>
          <label class="sub" for="r-cat-list">List</label>
        </div>
      </details>

      <h4>Blog Management</h4>
      <details class="menu-group" open>
        <summary>Blogs</summary>
        <div>
          <label class="sub" for="r-blog-create">Create</label>
          <label class="sub" for="r-blog-list">List</label>
        </div>
      </details>

      <!-- NEW: Banner Management -->
      <h4>Banner</h4>
      <details class="menu-group" open>
        <summary>Homepage Banner</summary>
        <div>
          <label class="sub" for="r-banner">Settings</label>
          <label class="sub" for="r-banner-list">List</label><!-- NEW -->
        </div>
      </details>
    </nav>
  </aside>

  <!-- Main column -->
  <section class="main">
    <!-- Topbar -->
    <div class="topbar">
      <div class="search">
        <span style="opacity:.6">üîé</span>
        <input id="q" placeholder="Search.." aria-label="Search" />
      </div>
      <div class="row profile-top">
        <span style="opacity:.6">‚õ∂</span>
        <label for="pfFile" class="pf-btn hide-sm">Upload photo</label>
        <input id="pfFile" type="file" accept="image/*" class="pf-input">
        <div class="pf-avatar-top" id="pfAvatar">Ôºã</div>
      </div>
    </div>

    <!-- Hidden switches to control panels (CSS only) -->
    <input class="switch" type="radio" name="section" id="r-cat-create" checked>
    <input class="switch" type="radio" name="section" id="r-cat-list">
    <input class="switch" type="radio" name="section" id="r-blog-create">
    <input class="switch" type="radio" name="section" id="r-blog-list">
    <!-- NEW: Banner switches -->
    <input class="switch" type="radio" name="section" id="r-banner">
    <input class="switch" type="radio" name="section" id="r-banner-list"><!-- NEW -->

    <!-- üîß Inline patch so Banner panels toggle without touching your global CSS -->
    <style>
      #r-banner:checked ~ .content #panel-banner { display:block; }
      #r-banner-list:checked ~ .content #panel-banner-list { display:block; } /* NEW */
    </style>

    <!-- Content Panels -->
    <div class="content">
      <!-- Category: Create -->
      <section id="panel-cat-create" class="panel card pad">
        <h3>Create Category</h3>
        <form id="catCreateForm">
          <div class="form-row" style="margin-top:8px">
            <div>
              <label>Category name</label>
              <input id="catName" placeholder="e.g. UI/UX" required />
            </div>
            <div>
              <label>Thumbnail</label>
              <input id="catThumb" type="file" accept="image/*" />
            </div>
            <div style="grid-column:1/-1">
              <label>Description</label>
              <textarea id="catDesc" placeholder="What this category covers"></textarea>
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <button class="btn primary" type="submit">Save</button>
            <button class="btn ghost" type="reset">Clear</button>
            <button id="catCancelEdit" class="btn" type="button" style="display:none">Cancel edit</button>
          </div>
        </form>
      </section>

      <!-- Category: List -->
      <section id="panel-cat-list" class="panel card pad">
        <h3>Categories</h3>
        <table class="table" style="margin-top:8px">
          <thead>
            <tr><th>Name</th><th>Slug</th><th>Description</th><th>Thumb</th><th>Actions</th></tr>
          </thead>
          <tbody id="catTbody">
            <tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </section>

      <!-- Blog: Create -->
      <section id="panel-blog-create" class="panel card pad">
        <h3>Blog Information</h3>
        <form id="postCreateForm">
          <div class="form-row" style="margin-top:8px">
            <div>
              <label>Category</label>
              <select id="postCategory"><option value="">== Select Category ==</option></select>
            </div>
            <div>
              <label>Title</label>
              <input id="postTitle" placeholder="Enter blog title" required />
            </div>
          </div>

          <div class="form-row" style="margin-top:10px">
            <div>
              <label>Thumbnail</label>
              <input id="postThumb" type="file" accept="image/*" />
            </div>
            <div>
              <label>Status</label>
              <select id="postStatus">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
          </div>

          <div class="form-row" style="margin-top:10px">
            <div>
              <label>Read time (minutes)</label>
              <input id="postRead" type="number" min="1" value="5" />
            </div>
            <div>
              <label>Excerpt</label>
              <input id="postExcerpt" placeholder="Short summary for cards" />
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Content</label>
            <textarea id="postContent" placeholder="Write your blog content here..."></textarea>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn primary" type="submit">Submit</button>
            <button class="btn ghost" type="reset">Clear</button>
            <button id="postCancelEdit" class="btn" type="button" style="display:none">Cancel edit</button>
          </div>
        </form>
      </section>

      <!-- Blog: List -->
      <section id="panel-blog-list" class="panel card pad">
        <h3>Blog List</h3>
        <table class="table" style="margin-top:8px">
          <thead>
            <tr><th>Title</th><th>Category</th><th>Status</th><th>Cover</th><th>Actions</th></tr>
          </thead>
          <tbody id="postTbody">
            <tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </section>

      <!-- NEW: Banner Settings -->
      <section id="panel-banner" class="panel card pad">
        <h3>Banner Settings</h3>
        <form id="bannerForm" enctype="multipart/form-data">
          <div class="form-row" style="margin-top:8px">
            <div>
              <label>Image 1</label>
              <input id="bannerImg1" type="file" accept="image/*" />
              <div style="margin-top:6px">
                <img id="bannerImg1Preview" alt="" style="max-width:140px;border:1px solid var(--line);border-radius:8px;display:none">
              </div>
            </div>
            <div>
              <label>Image 2</label>
              <input id="bannerImg2" type="file" accept="image/*" />
              <div style="margin-top:6px">
                <img id="bannerImg2Preview" alt="" style="max-width:140px;border:1px solid var(--line);border-radius:8px;display:none">
              </div>
            </div>
          </div>

          <div class="form-row" style="margin-top:10px">
            <div style="grid-column:1/-1">
              <label>Banner Heading *</label>
              <input id="bannerHeading" placeholder="E.g., Welcome to Wow Blog" required />
            </div>
          </div>

          <div class="form-row" style="margin-top:10px">
            <div style="grid-column:1/-1">
              <label>Banner Content *</label>
              <textarea id="bannerContent" placeholder="Short hero text for the homepage" required></textarea>
            </div>
          </div>

          <div class="form-row" style="margin-top:10px">
            <div>
              <label>Button 1 Label</label>
              <input id="bannerBtn1Text" placeholder="e.g. Learn more" />
            </div>
            <div>
              <label>Button 1 Link (URL or slug)</label>
              <input id="bannerBtn1Link" placeholder="/about or https://‚Ä¶" />
            </div>
          </div>

          <div class="form-row" style="margin-top:10px">
            <div>
              <label>Button 2 Label</label>
              <input id="bannerBtn2Text" placeholder="e.g. Contact us" />
            </div>
            <div>
              <label>Button 2 Link (URL or slug)</label>
              <input id="bannerBtn2Link" placeholder="/contact or https://‚Ä¶" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn primary" type="submit">Save Banner</button>
            <button class="btn ghost" type="reset">Clear</button>
          </div>
        </form>
      </section>

      <!-- NEW: Banner List -->
      <section id="panel-banner-list" class="panel card pad">
        <h3>Banner List</h3>
        <table class="table" style="margin-top:8px">
          <thead>
            <tr>
              <th>Heading</th>
              <th>Content</th>
              <th>Images</th>
              <th>Button 1</th>
              <th>Button 2</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="bannerTbody">
            <tr><td colspan="6" class="muted">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </section>

    </div>
  </section>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>


<script>
(function () {
  if (window.AdminInit) return;
  window.AdminInit = true;

  const API = '';
  const $ = s => document.querySelector(s);
  const el = (tag, attrs = {}) => {
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k, v]) => {
      if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else n.setAttribute(k, v);
    });
    return n;
  };

  /* ---------- UI helpers ---------- */
  const toast = (msg, duration = 2200) => {
    const t = $('#toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), duration);
  };

  const typeWriter = (text, cb) => {
    let i = 0, out = '';
    const interval = setInterval(() => {
      out += text.charAt(i++);
      cb && cb(out);
      if (i >= text.length) clearInterval(interval);
    }, 15);
  };

  const modalConfirm = (msg) =>
    new Promise(resolve => resolve(confirm(msg)));

  /* ---------- API ---------- */
  async function api(method, url, body, isForm) {
    const opts = { method };
    if (body) {
      if (isForm) {
        opts.body = body;
      } else {
        opts.headers = { 'Content-Type': 'application/json' };
        opts.body = JSON.stringify(body);
      }
    }
    const r = await fetch(API + url, opts);
    if (!r.ok) {
      let m = 'Request failed';
      try { const j = await r.json(); m = j.detail || JSON.stringify(j); } catch {}
      throw new Error(m);
    }
    const ct = r.headers.get('content-type') || '';
    return ct.includes('application/json') ? r.json() : r.text();
  }

  async function upload(file, type) {
    if (!file) return null;
    const fd = new FormData();
    fd.append('type', type || 'misc');
    fd.append('file', file);
    const res = await api('POST', '/api/upload', fd, true);
    return res.url;
  }

  /* =========================================================
   * Categories
   * ========================================================= */
  let editingCatId = null;
  let categoriesCache = [];
  const catForm = $('#catCreateForm');
  const catCancelEdit = $('#catCancelEdit');
  const catTbody = $('#catTbody');

  function resetCatForm() {
    catForm.reset();
    editingCatId = null;
    if (catCancelEdit) catCancelEdit.style.display = 'none';
  }

  async function loadCategories(q) {
    const qs = q ? `?q=${encodeURIComponent(q)}` : '';
    const rows = await api('GET', '/api/categories' + qs);
    categoriesCache = rows;
    if (!catTbody) return;
    catTbody.innerHTML = '';
    if (!rows.length) {
      catTbody.appendChild(el('tr', { html: '<td colspan="5" class="muted">No categories yet</td>' }));
    }
    rows.forEach(c => {
      const tr = el('tr');
      tr.appendChild(el('td', { text: c.name }));
      tr.appendChild(el('td', { html: `<span class="pill">${c.slug}</span>` }));
      tr.appendChild(el('td', { text: c.description || '' }));
      tr.appendChild(el('td', {
        html: c.thumbnail_url ? `<a href="${c.thumbnail_url}" target="_blank">thumb</a>` : '<span class="muted">‚Äî</span>'
      }));
      const tdA = el('td');
      const btnV = el('button', { class: 'btn info', text: 'View' });
      const btnE = el('button', { class: 'btn', text: 'Edit' });
      const btnD = el('button', { class: 'btn danger', text: 'Delete' });
      btnV.onclick = () => viewCategory(c);
      btnE.onclick = () => startEditCategory(c);
      btnD.onclick = () => deleteCategory(c.id);
      tdA.append(btnV, btnE, btnD);
      tr.appendChild(tdA);
      catTbody.appendChild(tr);
    });
    fillCategorySelect();
  }

  function fillCategorySelect() {
    const sel = $('#postCategory');
    if (!sel) return;
    const val = sel.value;
    sel.innerHTML = '<option value="">== Select Category ==</option>';
    categoriesCache.forEach(c =>
      sel.appendChild(el('option', { value: String(c.id), text: c.name }))
    );
    const opt = Array.from(sel.options).find(o => o.value === val);
    if (opt) sel.value = val;
  }

  function startEditCategory(c) {
    const radio = $('#r-cat-create');
    if (radio) radio.checked = true;
    $('#catName').value = c.name || '';
    $('#catDesc').value = c.description || '';
    $('#catThumb').value = '';
    editingCatId = c.id;
    if (catCancelEdit) catCancelEdit.style.display = 'inline-block';
    toast(`Editing category: ${c.name}`);
  }

  function viewCategory(c) {
    const msg = `Name: ${c.name}\nSlug: ${c.slug}\nDescription: ${c.description || '‚Äî'}\nCreated: ${c.created_at}`;
    typeWriter(msg, txt => { toast(txt); });
  }

  async function deleteCategory(id) {
    if (!(await modalConfirm('Delete this category?'))) return;
    try {
      await api('DELETE', '/api/categories/' + id);
      toast('Category deleted üóëÔ∏è');
      await loadCategories($('#q')?.value.trim() || '');
    } catch (e) {
      toast(e.message);
    }
  }

  catCancelEdit?.addEventListener('click', () => resetCatForm());

  catForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = $('#catName').value.trim();
    const description = $('#catDesc').value.trim();
    const file = $('#catThumb').files[0] || null;
    if (!name) return toast('Name is required ‚ö†Ô∏è');
    try {
      const fd = new FormData();
      fd.append('name', name);
      if (description) fd.append('description', description);
      if (file) fd.append('thumbnail', file);
      if (editingCatId) {
        await api('PUT', '/api/categories/' + editingCatId, fd, true);
        toast('Category updated ‚úÖ');
      } else {
        await api('POST', '/api/categories', fd, true);
        toast('Category created üéâ');
      }
      resetCatForm();
      await loadCategories($('#q')?.value.trim() || '');
    } catch (err) {
      toast(err.message);
    }
  });

  /* =========================================================
   * Posts
   * ========================================================= */
  let editingPostId = null;
  const postForm = $('#postCreateForm');
  const postCancelEdit = $('#postCancelEdit');
  const postTbody = $('#postTbody');

  function resetPostForm() {
    postForm?.reset();
    editingPostId = null;
    const read = $('#postRead');
    if (read) read.value = 5;
    if (postCancelEdit) postCancelEdit.style.display = 'none';
    fillCategorySelect();
  }

  async function loadPosts(q) {
    const qs = q ? `?q=${encodeURIComponent(q)}` : '';
    const rows = await api('GET', '/api/posts' + qs);
    if (!postTbody) return;
    postTbody.innerHTML = '';
    if (!rows.length) {
      postTbody.appendChild(el('tr', { html: '<td colspan="5" class="muted">No posts yet</td>' }));
    }
    rows.forEach(p => {
      const tr = el('tr');
      tr.appendChild(el('td', { text: p.title }));
      const catName = (categoriesCache.find(c => String(c.id) === String(p.category_id)) || {}).name || '‚Äî';
      tr.appendChild(el('td', { text: catName }));
      tr.appendChild(el('td', { html: `<span class="pill">${p.status || 'active'}</span>` }));
      tr.appendChild(el('td', {
        html: p.cover_url ? `<a href="${p.cover_url}" target="_blank">cover</a>` : '<span class="muted">‚Äî</span>'
      }));
      const tdA = el('td');
      const btnV = el('button', { class: 'btn info', text: 'View' });
      const btnE = el('button', { class: 'btn', text: 'Edit' });
      const btnD = el('button', { class: 'btn danger', text: 'Delete' });
      btnV.onclick = () => viewPost(p);
      btnE.onclick = () => startEditPost(p);
      btnD.onclick = () => deletePost(p.id);
      tdA.append(btnV, btnE, btnD);
      tr.appendChild(tdA);
      postTbody.appendChild(tr);
    });
  }

  function viewPost(p) {
    const catName = (categoriesCache.find(c => String(c.id) === String(p.category_id)) || {}).name || '‚Äî';
    const msg = `üìù ${p.title}
üìÅ ${catName}
üìå ${p.excerpt || '‚Äî'}
üìÑ ${p.content || '‚Äî'}
üìä ${p.status} | ‚è±Ô∏è ${p.read_time} min
üìÖ ${p.created_at}`;
    typeWriter(msg, t => toast(t, 2600));
  }

  function startEditPost(p) {
    const radio = $('#r-blog-create');
    if (radio) radio.checked = true;
    $('#postTitle').value = p.title || '';
    $('#postExcerpt').value = p.excerpt || '';
    $('#postContent').value = p.content || '';
    $('#postStatus').value = p.status || 'active';
    $('#postRead').value = p.read_time || 5;
    $('#postThumb').value = '';
    $('#postCategory').value = p.category_id ? String(p.category_id) : '';
    editingPostId = p.id;
    if (postCancelEdit) postCancelEdit.style.display = 'inline-block';
    toast(`Editing post: ${p.title}`);
  }

  async function deletePost(id) {
    if (!(await modalConfirm('Delete this post?'))) return;
    try {
      await api('DELETE', '/api/posts/' + id);
      toast('Post deleted üóëÔ∏è');
      await loadPosts($('#q')?.value.trim() || '');
    } catch (e) {
      toast(e.message);
    }
  }

  postCancelEdit?.addEventListener('click', () => resetPostForm());

  postForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = $('#postTitle').value.trim();
    const excerpt = $('#postExcerpt')?.value.trim() || '';
    const content = $('#postContent').value.trim();
    const status = $('#postStatus').value;
    const read_time = Number($('#postRead').value || 5);
    const category_id = $('#postCategory').value ? Number($('#postCategory').value) : '';
    const file = $('#postThumb').files[0] || null;

    if (!title) return toast('Title is required ‚ö†Ô∏è');
    if (!category_id) return toast('Please select a category üìÇ');
    if (!content) return toast('Content is required üìù');

    try {
      const fd = new FormData();
      fd.append('title', title);
      if (excerpt) fd.append('excerpt', excerpt);
      if (content) fd.append('content', content);
      fd.append('status', status);
      fd.append('read_time', String(read_time || 5));
      if (category_id !== '') fd.append('category_id', String(category_id));
      if (file) fd.append('thumbnail', file);
      if (editingPostId) {
        await api('PUT', '/api/posts/' + editingPostId, fd, true);
        toast('Post updated ‚úÖ');
      } else {
        await api('POST', '/api/posts', fd, true);
        toast('Post created ‚ú®');
      }
      resetPostForm();
      await Promise.all([loadCategories($('#q')?.value.trim() || ''), loadPosts($('#q')?.value.trim() || '')]);
    } catch (err) {
      toast(err.message);
    }
  });

  /* =========================================================
   * Banner (Create/Update + List like Categories/Posts)
   * ========================================================= */
  const bannerForm = $('#bannerForm');
  const bannerImg1 = $('#bannerImg1');
  const bannerImg2 = $('#bannerImg2');
  const bannerImg1Preview = $('#bannerImg1Preview');
  const bannerImg2Preview = $('#bannerImg2Preview');

  const bannerHeading = $('#bannerHeading');
  const bannerContent = $('#bannerContent');

  // Optional text fields (if you added them). If not present, we keep them blank.
  const bannerBtn1Text = $('#bannerBtn1Text') || null;
  const bannerBtn2Text = $('#bannerBtn2Text') || null;

  // Link inputs ‚Äì support any of these ids for compatibility
  const bannerBtn1Link = $('#bannerBtn1Link') || $('#bannerBtn1Url') || $('#bannerGo1') || null;
  const bannerBtn2Link = $('#bannerBtn2Link') || $('#bannerBtn2Url') || $('#bannerGo2') || null;

  // List table body (new)
  const bannerTbody = $('#bannerTbody');

  let bannerCache = null;
  const bannerState = {
    image1_url: null,
    image2_url: null,
    heading: '',
    content: '',
    btn1_text: '',
    btn1_link: '',
    btn2_text: '',
    btn2_link: ''
  };

  function setImgPreview(imgEl, src) {
    if (!imgEl) return;
    if (src) {
      imgEl.src = src;
      imgEl.style.display = 'block';
    } else {
      imgEl.removeAttribute('src');
      imgEl.style.display = 'none';
    }
  }

  async function loadBanner() {
    try {
      const data = await api('GET', '/api/banner');
      bannerCache = data;
      Object.assign(bannerState, {
        image1_url: data.image1_url || null,
        image2_url: data.image2_url || null,
        heading:    data.heading    || '',
        content:    data.content    || '',
        btn1_text:  data.btn1_text  || '',
        btn1_link:  data.btn1_link  || data.btn1_url || data.go1 || '',
        btn2_text:  data.btn2_text  || '',
        btn2_link:  data.btn2_link  || data.btn2_url || data.go2 || ''
      });
    } catch (_) {
      bannerCache = null;
      Object.assign(bannerState, {
        image1_url: null, image2_url: null, heading:'', content:'',
        btn1_text:'', btn1_link:'', btn2_text:'', btn2_link:''
      });
    }

    // populate form
    if (bannerHeading) bannerHeading.value = bannerState.heading;
    if (bannerContent) bannerContent.value = bannerState.content;
    if (bannerBtn1Text) bannerBtn1Text.value = bannerState.btn1_text;
    if (bannerBtn2Text) bannerBtn2Text.value = bannerState.btn2_text;
    if (bannerBtn1Link) bannerBtn1Link.value = bannerState.btn1_link;
    if (bannerBtn2Link) bannerBtn2Link.value = bannerState.btn2_link;
    setImgPreview(bannerImg1Preview, bannerState.image1_url);
    setImgPreview(bannerImg2Preview, bannerState.image2_url);
  }

  async function loadBannerList() {
    if (!bannerTbody) return;
    bannerTbody.innerHTML = '';
    try {
      const b = await api('GET', '/api/banner');
      bannerCache = b;
      const tr = el('tr');
      // Heading
      tr.appendChild(el('td', { text: b.heading || '‚Äî' }));
      // Content (shortened)
      tr.appendChild(el('td', { text: (b.content || '‚Äî').slice(0, 80) + ((b.content && b.content.length > 80) ? '‚Ä¶' : '') }));
      // Images
      tr.appendChild(el('td', {
        html: [
          b.image1_url ? `<a href="${b.image1_url}" target="_blank">img1</a>` : '<span class="muted">‚Äî</span>',
          b.image2_url ? `<a href="${b.image2_url}" target="_blank">img2</a>` : '<span class="muted">‚Äî</span>',
        ].join(' / ')
      }));
      // Buttons
      const btn1Txt = b.btn1_text || '‚Äî';
      const btn1Lnk = b.btn1_link || b.btn1_url || b.go1 || '';
      const btn2Txt = b.btn2_text || '‚Äî';
      const btn2Lnk = b.btn2_link || b.btn2_url || b.go2 || '';
      tr.appendChild(el('td', { html: `<span class="pill">${btn1Txt}</span> ${btn1Lnk ? `‚Üí <code>${btn1Lnk}</code>` : ''}` }));
      tr.appendChild(el('td', { html: `<span class="pill">${btn2Txt}</span> ${btn2Lnk ? `‚Üí <code>${btn2Lnk}</code>` : ''}` }));

      // Actions
      const tdA = el('td');
      const btnV = el('button', { class: 'btn info', text: 'View' });
      const btnE = el('button', { class: 'btn', text: 'Edit' });
      const btnD = el('button', { class: 'btn danger', text: 'Delete' });
      btnV.onclick = () => viewBanner(b);
      btnE.onclick = () => startEditBanner(b);
      btnD.onclick = () => deleteBanner();
      tdA.append(btnV, btnE, btnD);
      tr.appendChild(tdA);
      bannerTbody.appendChild(tr);
    } catch (e) {
      // 404 ‚Üí No banner configured
      const tr = el('tr');
      tr.appendChild(el('td', { html: '<span class="muted">No banner configured</span>', colspan: '6' }));
      bannerTbody.appendChild(tr);
    }
  }

  function viewBanner(b) {
    const msg = `üè≥Ô∏è Banner
üñºÔ∏è  img1: ${b.image1_url || '‚Äî'}
üñºÔ∏è  img2: ${b.image2_url || '‚Äî'}
üè∑Ô∏è  heading: ${b.heading || '‚Äî'}
‚úèÔ∏è  content: ${b.content || '‚Äî'}
üîò  btn1: ${b.btn1_text || '‚Äî'} ‚Üí ${b.btn1_link || b.btn1_url || b.go1 || '‚Äî'}
üîò  btn2: ${b.btn2_text || '‚Äî'} ‚Üí ${b.btn2_link || b.btn2_url || b.go2 || '‚Äî'}
‚åö  updated: ${b.updated_at || '‚Äî'}`;
    typeWriter(msg, t => toast(t, 2600));
  }

  function startEditBanner(b) {
    const r = $('#r-banner');
    if (r) r.checked = true;
    if (bannerHeading) bannerHeading.value = b.heading || '';
    if (bannerContent) bannerContent.value = b.content || '';
    if (bannerBtn1Text) bannerBtn1Text.value = b.btn1_text || '';
    if (bannerBtn2Text) bannerBtn2Text.value = b.btn2_text || '';
    if (bannerBtn1Link) bannerBtn1Link.value = b.btn1_link || b.btn1_url || b.go1 || '';
    if (bannerBtn2Link) bannerBtn2Link.value = b.btn2_link || b.btn2_url || b.go2 || '';
    setImgPreview(bannerImg1Preview, b.image1_url || '');
    setImgPreview(bannerImg2Preview, b.image2_url || '');
    toast('Editing banner');
  }

  async function deleteBanner() {
    if (!(await modalConfirm('Delete banner settings?'))) return;
    try {
      await api('DELETE', '/api/banner');
      toast('Banner deleted üóëÔ∏è');
      // Clear form + previews
      if (bannerForm) bannerForm.reset();
      setImgPreview(bannerImg1Preview, null);
      setImgPreview(bannerImg2Preview, null);
      await loadBannerList();
    } catch (e) {
      toast(e.message || 'Failed to delete banner');
    }
  }

  // local image preview
  bannerImg1?.addEventListener('change', () => {
    const f = bannerImg1.files?.[0];
    if (f) setImgPreview(bannerImg1Preview, URL.createObjectURL(f));
  });
  bannerImg2?.addEventListener('change', () => {
    const f = bannerImg2.files?.[0];
    if (f) setImgPreview(bannerImg2Preview, URL.createObjectURL(f));
  });

  bannerForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      const f1 = bannerImg1?.files?.[0] || null;
      const f2 = bannerImg2?.files?.[0] || null;
      const [url1, url2] = await Promise.all([
        f1 ? upload(f1, 'banner') : Promise.resolve(bannerState.image1_url),
        f2 ? upload(f2, 'banner') : Promise.resolve(bannerState.image2_url)
      ]);

      const payload = {
        image1_url: url1 || null,
        image2_url: url2 || null,
        heading:    bannerHeading?.value.trim() || '',
        content:    bannerContent?.value.trim() || '',
        // send canonical names expected by backend
        btn1_text:  bannerBtn1Text?.value.trim() || bannerState.btn1_text || '',
        btn1_link:  bannerBtn1Link?.value.trim() || '',
        btn2_text:  bannerBtn2Text?.value.trim() || bannerState.btn2_text || '',
        btn2_link:  bannerBtn2Link?.value.trim() || ''
      };

      await api('PUT', '/api/banner', payload, false);

      Object.assign(bannerState, payload);
      setImgPreview(bannerImg1Preview, bannerState.image1_url);
      setImgPreview(bannerImg2Preview, bannerState.image2_url);

      toast('Banner saved ‚úÖ');
      if (bannerImg1) bannerImg1.value = '';
      if (bannerImg2) bannerImg2.value = '';
      await loadBannerList();
    } catch (err) {
      toast(err.message || 'Failed to save banner');
    }
  });

  /* =========================================================
   * Search
   * ========================================================= */
  const q = $('#q');
  q?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const v = q.value.trim();
      loadCategories(v);
      loadPosts(v);
      // (no banner search; singleton)
    }
  });

  /* =========================================================
   * Profile upload (top-right)
   * ========================================================= */
  const pfFile = $('#pfFile');
  const pfAvatar = $('#pfAvatar');
  pfFile?.addEventListener('change', async () => {
    const f = pfFile.files[0];
    if (!f) return;
    try {
      const url = await upload(f, 'profile');
      if (pfAvatar) pfAvatar.innerHTML = `<img alt="pfp" src="${url}">`;
      toast('Profile uploaded ‚ú®');
    } catch (e) { toast(e.message); }
  });

  /* =========================================================
   * Init
   * ========================================================= */
  (async function init() {
    try {
      await loadCategories();
      await loadPosts();
      await loadBanner();
      await loadBannerList();
      toast('üéØ Connected to API');
    } catch (e) {
      toast('üö´ API error: ' + e.message);
    }
  })();
})();
</script>


</body>
</html>
